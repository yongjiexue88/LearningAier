name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - main

env:
  REGION: us-central1
  REPO_NAME: backend-api

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and Push Container
        id: build-image
        run: |
          cd backend-fastapi
          # Build using production project but tag for both
          IMAGE_TAG="gcr.io/learningaier/${{ env.REPO_NAME }}:${{ github.sha }}"
          gcloud builds submit --tag $IMAGE_TAG
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-production:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Prepare Secrets
        id: secrets
        env:
          FIREBASE_JSON: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}
        run: |
          echo "FIREBASE_CREDENTIALS_BASE64=$(echo "$FIREBASE_JSON" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Deploy to Production Cloud Run
        run: |
          gcloud run deploy learningaier-api \
            --image ${{ needs.build.outputs.image }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project learningaier \
            --allow-unauthenticated \
            --timeout=300 \
            --cpu-boost \
            --set-env-vars "APP_ENV=production" \
            --set-env-vars "FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" \
            --set-env-vars "FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" \
            --set-env-vars "FIREBASE_CREDENTIALS_JSON=${{ steps.secrets.outputs.FIREBASE_CREDENTIALS_BASE64 }}" \
            --set-env-vars "LLM_PROVIDER=gemini" \
            --set-env-vars "LLM_MODEL=gemini-2.0-flash-lite" \
            --set-env-vars "LLM_API_KEY=${{ secrets.LLM_API_KEY }}" \
            --set-env-vars "EMBEDDINGS_PROVIDER=gemini" \
            --set-env-vars "EMBEDDINGS_MODEL=text-embedding-004" \
            --set-env-vars "EMBEDDINGS_API_KEY=${{ secrets.LLM_API_KEY }}" \
            --set-env-vars "EMBEDDINGS_DIMENSIONS=768" \
            --set-env-vars "VECTOR_DB_PROVIDER=pinecone" \
            --set-env-vars "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" \
            --set-env-vars "PINECONE_INDEX_NAME=learningaier-index" \
            --set-env-vars "PINECONE_INDEX_HOST=${{ secrets.PINECONE_INDEX_HOST }}" \
            --set-env-vars "PINECONE_ENVIRONMENT=us-east-1"

  deploy-lab:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Google Auth for Lab
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY_LAB }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Copy Image to Lab Project
        run: |
          # Tag and push image to lab project registry
          gcloud auth configure-docker
          docker pull ${{ needs.build.outputs.image }}
          docker tag ${{ needs.build.outputs.image }} gcr.io/learningaier-lab/${{ env.REPO_NAME }}:${{ github.sha }}
          docker push gcr.io/learningaier-lab/${{ env.REPO_NAME }}:${{ github.sha }}

      - name: Prepare Secrets
        id: secrets
        env:
          FIREBASE_JSON: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}
        run: |
          echo "FIREBASE_CREDENTIALS_BASE64=$(echo "$FIREBASE_JSON" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Deploy to Lab Cloud Run
        run: |
          gcloud run deploy learningaier-lab-api \
            --image gcr.io/learningaier-lab/${{ env.REPO_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project learningaier-lab \
            --allow-unauthenticated \
            --timeout=300 \
            --cpu-boost \
            --set-env-vars "APP_ENV=lab" \
            --set-env-vars "FIREBASE_PROJECT_ID=${{ secrets.VITE_FIREBASE_PROJECT_ID }}" \
            --set-env-vars "FIREBASE_STORAGE_BUCKET=${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}" \
            --set-env-vars "FIREBASE_CREDENTIALS_JSON=${{ steps.secrets.outputs.FIREBASE_CREDENTIALS_BASE64 }}" \
            --set-env-vars "LLM_PROVIDER=gemini" \
            --set-env-vars "LLM_MODEL=gemini-2.0-flash-lite" \
            --set-env-vars "LLM_API_KEY=${{ secrets.LLM_API_KEY }}" \
            --set-env-vars "EMBEDDINGS_PROVIDER=gemini" \
            --set-env-vars "EMBEDDINGS_MODEL=text-embedding-004" \
            --set-env-vars "EMBEDDINGS_API_KEY=${{ secrets.LLM_API_KEY }}" \
            --set-env-vars "EMBEDDINGS_DIMENSIONS=768" \
            --set-env-vars "VECTOR_DB_PROVIDER=pinecone" \
            --set-env-vars "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" \
            --set-env-vars "PINECONE_INDEX_NAME=learningaier-index" \
            --set-env-vars "PINECONE_INDEX_HOST=${{ secrets.PINECONE_INDEX_HOST }}" \
            --set-env-vars "PINECONE_ENVIRONMENT=us-east-1"
